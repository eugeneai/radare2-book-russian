## Добавление метаданных к тексту дизассемблера

Типичная работа, связанная с взломом двоичных файлов, — аннотация, она значительно увеличивает производительность процесса.
Radare предлагает несколько способов хранения и извлечения таких метаданных.

Следуя общим основным принципам UNIX, легко написать небольшую утилиту на языке сценариев, которая использует `objdump`, `otool` или любую другую существующую утилиту для получения информации из двоичного файла, и импортировать ее результаты в radare. Например, взгляните на `idc2r.py`, которая поставляется с [radare2ida](https://github.com/radareorg/radare2ida). Ее использование — запуск `idc2r.py file.idc > file.r2`. Она считывает файл IDC, экспортированный из базы данных IDA Pro, и создает скрипт r2, содержащий те же комментарии, имена функций и другие данные. Полученный файл 'file.r2' можно импортировать с помощью команды "точка" (`.`) radar-а:
```
[0x00000000]> . file.r2
```
Команда `.` используется для интерпретации команд Radare из внешних источников, включая файлы и выходные данные программы. Чтобы пропустить генерацию промежуточного файла и импортировать скрипт напрямую, можно использовать такую комбинацию:
```
[0x00000000]> .!idc2r.py < file.idc
```

Импорт метаданных IDA Pro из дампа IDC является устаревшим механизмом и может перестать работать в будущем. Рекомендуемый способ — использовать скрипт `ida2r2.py`, основанный на [python-idb](https://github.com/williballenthin/python-idb), он открывает IDB-файлы напрямую без установки IDA Pro.

Команда `C` используется для управления комментариями и отображением данных. Можно снабдить некоторый диапазон байтов метаданными, указывающими как его следует интерпретировать: код, блок двоичных данных или строкой. Также можно запустить внешнюю программу, передав ей часть данных флага. Программа должна провести анализ и передать обратно метаданные, например, комментарии. Данные для анализа никто не запрещает получать из внешнего файла или базы данных, в том числе.

Существует множество различных команд задания метаданных, вот краткий обзор некоторых из них:

```
[0x00404cc0]> C?
| Usage: C[-LCvsdfm*?][*?] [...]   # Управление метаданными
| C                                              перечислить метаданные в виде текста
| C*                                             перечислить метаданные в виде команд r2
| C*.                                            перечень метаданных, привязанных к текущему смещению, ыормат команд r2
| C- [len] [[@]addr]                             удалить метаданные, привязанные к заданному диапазону адресов
| C.                                             перечислить метаданные, привязанные к текущему смещению в виде текста
| CC! [@addr]                                    редактировать комментарий при помощи $EDITOR-а
| CC[?] [-] [comment-text] [@addr]               добавить/удалить комментарий
| CC.[addr]                                      показат комментарий, привязанный к текущему адресу
| CCa[-at]|[at] [text] [@addr]                   добавить/удалить комментарий, привязанный к текущему адресу
| CCu [comment-text] [@addr]                     добавить уникальный комментарий
| CF[sz] [fcn-sign..] [@addr]                    сигнатура функции
| CL[-][*] [file:line] [addr]                    показать или добавить 'code line'-информацию (bininfo)
| CS[-][space]                                   управление meta-пространствами для фильтрации комментариев и т.п.
| C[Cthsdmf]                                     перечислить комментарии/типы/скрытое/строки/данные/magic-и в виде текста
| C[Cthsdmf]*                                    перечислить комментарии/типы/скрытое/строки/данные/magic-и в виде команд r2
| Cd[-] [size] [repeat] [@addr]                  сделать шестнадцатеричный дамп массива данных (Cd 4 10 == dword [10])
| Cd. [@addr]                                    показать размер данныз по текущему адресу
| Cf[?][-] [sz] [0|cnt][fmt] [a0 a1...] [@addr]  задать формат области память (смотрите pf?)
| Ch[-] [size] [@addr]                           скрыть данные
| Cm[-] [sz] [fmt..] [@addr]                     распознать magic (смотрите pm?)
| Cs[?] [-] [size] [@addr]                       добавить строку
| Ct[?] [-] [comment-text] [@addr]               добавить/удалить комментарий об анализе типа
| Ct.[@addr]                                     показать содержимое по текущему смещению или заданному адресу
| Cv[bsr][?]                                     добавить комментарий к аргументу функции
| Cz[@addr]                                      добавить строку (смотрите Cs?)
```

Добавление комментария к определенной строке/адресу — команда `Ca` :

```
[0x00000000]> CCa 0x0000002 this guy seems legit
[0x00000000]> pd 2
0x00000000    0000         add [rax], al
;      this guy seems legit
0x00000002    0000         add [rax], al
```

Семейство команд `C?` позволяет пометить некоторый диапазон адресов заданным типом. Три основных типа метаданных — это код (дизассемблирование выполняется с помощью asm.arch), блок данных (массив элементов данных) или строка. Команда `cs` - определение метаданных для строки, команда `Cd` - для массива элементов данных, команда `Cf` - определение сложных структур данных.

Аннотация типов данных легче всего выполнять в визуальном режиме, используя клавишу «d», сокращение от "data type change". Используйте курсор для выбора диапазона байтов (нажмите клавишу `c`, чтобы переключить режим курсора, используйте клавиши HJKL для определения области выделения), затем нажмите «d», чтобы получить меню возможных действий/типов. Например, чтобы пометить диапазон как строку, используйте опцию 's' из меню. В командной строке такой же результат получается при помощи команды `Cs`:

```
[0x00000000]> f string_foo @ 0x800
[0x00000000]> Cs 10 @ string_foo
```

Команда `Cf` используется для определения структуры для участка памяти (используется тот же синтаксис, что в команде `pf`). Вот пример:

```
[0x7fd9f13ae630]> Cf 16 2xi foo bar
[0x7fd9f13ae630]> pd
;-- rip:
0x7fd9f13ae630 format 2xi foo bar {
0x7fd9f13ae630 [0] {
 foo : 0x7fd9f13ae630 = 0xe8e78948
 bar : 0x7fd9f13ae634 = 14696
}
0x7fd9f13ae638 [1] {
 foo : 0x7fd9f13ae638 = 0x8bc48949
 bar : 0x7fd9f13ae63c = 571928325
}
} 16
0x7fd9f13ae633    e868390000   call 0x7fd9f13b1fa0
0x7fd9f13ae638    4989c4       mov r12, rax
```

Аргумент `[sz]` у `Cf` используется для задания количества байтов, занимаемых структурой при дизассемблировании, она полностью независима от размера структуры данных, определяемой строкой задания формата. Может это кажется странным, но этому есть несколько применений. Например, можно задать и форматирование структуры, отображаемой при дизассемблировании, и по-прежнему отображать эти адреса в виде смещений и байтов. Для больших структур удобно идентифицировать только несколько полей, если нужны только они. Затем можно указать r2 отображать только эти поля, используя строку формата и специальные 'skip'-поля, а также продолжить дизассемблирование после отображения всей структуры, задав ей полный размер с помощью аргумента `sz`. Использование `Cf` позволяет описывать сложные структуры при помощи простых однострочных командных выражений. Посмотрите инструкцию `pf?`.

Помните, что все команды группы `C` также доступны в визуальном режиме, нажав кнопку `d` (data conversion).
В отличие от команды [`t`](../analysis/types.md) команда `Cf` не изменяет результаты анализа. Это только инструмент визуализации.

Иногда добавление одной строки комментария бывает недостаточно, radare2 позволяет создавать ссылки на текстовые файлы. Функция реализуется командой `СС,` или нажатием клавиши `,` в  визуальном режиме. В результате откроется `$EDITOR` для создания нового файла, если файл существует, просто создаст ссылку. Файл будет показан в комментариях к коду:

```
[0x00003af7 11% 290 /bin/ls]> pd $r @ main+55 # 0x3af7
│0x00003af7  call sym.imp.setlocale        ;[1] ; ,(locale-help.txt) ; char *setlocale(int category, const char *locale)
│0x00003afc  lea rsi, str.usr_share_locale ; 0x179cc ; "/usr/share/locale"
│0x00003b03  lea rdi, [0x000179b2]         ; "coreutils"
│0x00003b0a  call sym.imp.bindtextdomain   ;[2] ; char *bindtextdomain(char *domainname, char *dirname)
```

Найдите `,(locale-help.txt)` в комментариях выше, если теперь снова нажать `,` в визуальном режиме, файл откроется. Используя этот механизм, создаются длинные описания конкретных мест в дизассемблированном коде, устанавливаются ссылки на документацию, статьи по теме.
