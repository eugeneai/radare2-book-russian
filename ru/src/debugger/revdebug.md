# Отладка в обратном направлении

Radare2 включает функцию реверс-отладки - перебор адресов инструкций программы в обратном направлении.
(reverse-next, reverse-continue)
Сначала надо сохранить состояние программы в нужный момент.
Синтаксис команды начала записи:

```
[0x004028a0]> dts+
```

Команды `dts` используются для записи состояний программ и управления ими.
После записи состояний можно устанавливать смещения счетчика инструкций вперед и назад в любые точки после точки начала записи.
Таким образом, можно попробовать сделать один шаг назад:

```
[0x004028a0]> 2dso
[0x004028a0]> dr rip
0x004028ae
[0x004028a0]> dsb
continue until 0x004028a2
hit breakpoint at: 4028a2
[0x004028a0]> dr rip
0x004028a2
```

При запуске `dsb` обратный отладчик восстанавливает предыдущее записанное состояние и запускает программу с этого состояния до нужной точки.

Можно попробовать продолжить в обратном направлении:

```
[0x004028a0]> db 0x004028a2
[0x004028a0]> 10dso
[0x004028a0]> dr rip
0x004028b9
[0x004028a0]> dcb
[0x004028a0]> dr rip
0x004028a2
```

`dcb` устанавливает счетчик программ на последнюю точку останова.
Как только точка останова установлена, можно вернуться к ней в любое время.

Просмотр списка записей состояний программы - `dts`:

```
[0x004028a0]> dts
session: 0   at:0x004028a0   ""
session: 1   at:0x004028c2   ""
```

ПРИМЕЧАНИЕ: Записи состояний можно сохранять в любое время. Они представлены в diff-формате, что позволяет сохранять только изменения памяти в сравнении с предыдущими версиями. Это экономит место в памяти, не надо хранить весь дамп.

Можно добавлять комментарии:

```
[0x004028c2]> dtsC 0 program start
[0x004028c2]> dtsC 1 decryption start
[0x004028c2]> dts
session: 0   at:0x004028a0   "program start"
session: 1   at:0x004028c2   "decryption start"
```

Можно делать заметки для каждой записи - ассоциировать с информацией в уме.
Команды `dsb` и `dcb` восстанавливают состояние программы из последней записи при наличии списка таких записей.

Записи программ экспортируются в файлы и импортируются из них.
Экспорт/импорт записей в/из файла:

```
[0x004028c2]> dtst records_for_test
Session saved in records_for_test.session and dump in records_for_test.dump
[0x004028c2]> dtsf records_for_test
session: 0, 0x4028a0 diffs: 0
session: 1, 0x4028c2 diffs: 0
```

Кроме того, можно выполнять реверс-отладку в режиме ESIL.
В режиме ESIL состоянием программы можно управлять при помощи команд  `aets`.

```
[0x00404870]> aets+
```

Шаг назад - `aesb`:

```
[0x00404870]> aer rip
0x00404870
[0x00404870]> 5aeso
[0x00404870]> aer rip
0x0040487d
[0x00404870]> aesb
[0x00404870]> aer rip
0x00404879
```

В дополнение к собственным возможностям реверс-отладки в radare2, также можно использовать протокол gdb для реверс-отладки на удаленном сервере (gdbserver), если сервер поддерживает эту функцию.
Команды `=!dsb` и `=!dcb` заменяют собой команды `dsb` и `dcb` для этой цели, изучайте инструкцию [remote gdb's documentation](remote_gdb.md).
