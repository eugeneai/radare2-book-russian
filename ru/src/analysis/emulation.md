# Эмуляция

Одна из самых важных вещей в обратном инжиниринге — понимание различия между статическим и динамическим анализом. Статический анализ страдает от проблемы комбинаторного взрыва, что невозможно решить даже самым простым способом без хотя бы частичной эмуляции. Многие профессиональные инструменты обратного проектирования используют эмуляцию кода в процессе реверс-инжениринга, и radare2 здесь не исключение.

Для частичной эмуляции (или неточной полной эмуляции) radare2 использует свой собственный язык [ESIL](../disassembling/esil.md) и виртуальную машину. Radare2 поддерживает эмуляцию для всех платформ, для которых заданы ESIL-эмуляторы (x86/x86_64, ARM, arm64, MIPS, powerpc, sparc, AVR, 8051, Gameboy, ...). Одним из распространенных применений такой эмуляции является расчет косвенных и условных переходов.

Чтобы увидеть ESIL-представление программы, нужно использовать команду `ao` или включить в конфигурации при помощи переменной `asm.esil`. Использование этого режима помогает проверить, правильно ли понимается код программы, освоить эмуляцию ESIL:

```
[0x00001660]> pdf
. (fcn) fcn.00001660 40
│   fcn.00001660 ();
│     ; CALL XREF from 0x00001713 (entry2.fini)
│     0x00001660  lea rdi, obj.__progname      ; 0x207220
│     0x00001667  push rbp
│     0x00001668  lea rax, obj.__progname      ; 0x207220
│     0x0000166f  cmp rax, rdi
│     0x00001672  mov rbp, rsp
│ .─< 0x00001675  je 0x1690
│ │   0x00001677  mov rax, qword [reloc._ITM_deregisterTMCloneTable] ; [0x206fd8:8]=0
│ │   0x0000167e  test rax, rax
│.──< 0x00001681  je 0x1690
│││   0x00001683  pop rbp
│││   0x00001684  jmp rax
│``─> 0x00001690  pop rbp
`     0x00001691  ret
[0x00001660]> e asm.esil=true
[0x00001660]> pdf
. (fcn) fcn.00001660 40
│   fcn.00001660 ();
│     ; CALL XREF from 0x00001713 (entry2.fini)
│     0x00001660  0x205bb9,rip,+,rdi,=
│     0x00001667  rbp,8,rsp,-=,rsp,=[8]
│     0x00001668  0x205bb1,rip,+,rax,=
│     0x0000166f  rdi,rax,==,$z,zf,=,$b64,cf,=,$p,pf,=,$s,sf,=,$o,of,=
│     0x00001672  rsp,rbp,=
│ .─< 0x00001675  zf,?{,5776,rip,=,}
│ │   0x00001677  0x20595a,rip,+,[8],rax,=
│ │   0x0000167e  0,rax,rax,&,==,$z,zf,=,$p,pf,=,$s,sf,=,$0,cf,=,$0,of,=
│.──< 0x00001681  zf,?{,5776,rip,=,}
│││   0x00001683  rsp,[8],rbp,=,8,rsp,+=
│││   0x00001684  rax,rip,=
│``─> 0x00001690  rsp,[8],rbp,=,8,rsp,+=
`     0x00001691  rsp,[8],rip,=,8,rsp,+=
```

Чтобы вручную настроить эмуляцию ESIL, необходимо выполнить следующую последовательность команд:

- `aei` для инициализации виртуальной машины ESIL,
- `aeim` для инициализации памяти виртуальной машины ESIL (стек),
- `aeip` - задание начального IP-адреса виртуальной машины ESIL (указатель инструкций),
- последовательность команд `aer` для задания начальных значений регистра.

При выполнении эмуляции помните, что виртуальная машина ESIL не может эмулировать внешние или системные вызовы вместе с инструкциями SIMD. Таким образом, наиболее распространенным сценарием использования является эмуляция небольшого куска кода, например шифрование/расшифрования, распаковка или вычисления. После успешной настройки виртуальной машины ESIL можно взаимодействовать с ней как в обычном режиме отладки. Интерфейс командной строки виртуальной машины ESIL практически идентичен интерфейсу отладчика:

- `aes` сделать шаг (или клавиша `s` в визуальном режиме, step),
- `aesi` для перешагивания через вызовы функций (step over),
- `aesu <address>` - выполнить шаг до указанного адреса (continue),
- `aesue <ESIL expression>` - выполнять шаги до тех пор, пока не будет истинным какое-либо указанное выражение ESIL,
- `aec` продолжать до прерывания по Ctrl-C, этот редко используется из-за вездесущности внешних вызовов.

В визуальном режиме все горячие клавиши отладки будут работать также в режиме эмуляции ESIL.

Наряду с обычной эмуляцией, есть возможность записи и режим воспроизведения (R&R):

- `aets` для перечисления всех текущих сессий ESIL R&R,
- `aets+` для создания новой сессии R&R,
- `aesb` - движение вперед и назад в текущей сессии ESIL R&R.

Подробнее об этом режиме работы можете прочесть в главе [Обратная отладка](../debugger/revdebug.md).

## Эмуляция в цикле анализа

Помимо ручного режима эмуляции, ESIL можно использовать автоматически в цикле анализа.
Например, команда `aaaa` выполняет этап эмуляции ESIL вместе с другими.
Для отключения или включения использования ESIL есть переменная конфигурации `anal.esil`.
Есть еще одна важная настройка, хотя и довольно опасная, особенно в случае вредоносного ПО - `emu.write`, которое позволяет виртуальной машине ESIL изменять содержимое памяти. Эта возможность очень полезна в процессе деобфускации или распаковки кода.

Для отображения данных в процессе эмуляции настраивается переменная `asm.emu`. В результате radare2 будет показывать вычисляемое значение регистра и памяти в комментариях к дизассемблированному коду:

```
[0x00001660]> e asm.emu=true
[0x00001660]> pdf
. (fcn) fcn.00001660 40
│   fcn.00001660 ();
│     ; CALL XREF from 0x00001713 (entry2.fini)
│     0x00001660  lea rdi, obj.__progname ; 0x207220 ; rdi=0x207220 -> 0x464c457f
│     0x00001667  push rbp                ; rsp=0xfffffffffffffff8
│     0x00001668  lea rax, obj.__progname ; 0x207220 ; rax=0x207220 -> 0x464c457f
│     0x0000166f  cmp rax, rdi            ; zf=0x1 -> 0x2464c45 ; cf=0x0 ; pf=0x1 -> 0x2464c45 ; sf=0x0 ; of=0x0
│     0x00001672  mov rbp, rsp            ; rbp=0xfffffffffffffff8
│ .─< 0x00001675  je 0x1690               ; rip=0x1690 -> 0x1f0fc35d ; likely
│ │   0x00001677  mov rax, qword [reloc._ITM_deregisterTMCloneTable] ; [0x206fd8:8]=0 ; rax=0x0
│ │   0x0000167e  test rax, rax           ; zf=0x1 -> 0x2464c45 ; pf=0x1 -> 0x2464c45 ; sf=0x0 ; cf=0x0 ; of=0x0
│.──< 0x00001681  je 0x1690               ; rip=0x1690 -> 0x1f0fc35d ; likely
│││   0x00001683  pop rbp                 ; rbp=0xffffffffffffffff -> 0x4c457fff ; rsp=0x0
│││   0x00001684  jmp rax                 ; rip=0x0 ..
│``─> 0x00001690  pop rbp                 ; rbp=0x10102464c457f ; rsp=0x8 -> 0x464c457f
`     0x00001691  ret                     ; rip=0x0 ; rsp=0x10 -> 0x3e0003
```

Обратите внимание на комментарии с меткой `likely`, где эмуляция ESIL предсказала переход. Помимо базовой настройки виртуальной машины ESIL, можно изменять ее поведение с помощью других доступных параметров в пространствах имен конфигурации `emu.` и `esil`. Для управления ESIL, работающей с памятью и стеком, можно использовать следующие варианты настроек:

- `esil.stack` для включения или отключения временного стека для режима `asm.emu`,
- `esil.stack.addr` для задания адреса стека в виртуальной машине ESIL (аналогично команде `aeim`),
- `esil.stack.size` для установки размера стека в виртуальной машине ESIL (аналогично команде `aeim`),
- `esil.stack.depth` ограничивает количество операций PUSH в стеке,
- `esil.romem` определяет доступ к памяти ESIL "только для чтения",
- `esil.fillstack` и `esil.stack.pattern` позволяют использовать различные шаблоны для заполнения стека виртуальной машины ESIL при инициализации,
- `esil.nonull` - остановить выполнение ESIL при чтении или записи нулевого указателя.
