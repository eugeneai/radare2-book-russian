## Добавление метаданных к тексту дизассемблера

Типичная работа, связанная с взломом двоичных файлов, - аннотация, она значительно увеличивает производительность процесса.
Radare предлагает несколько способов хранения и извлечения таких метаданных.

Следуя общим основным принципам UNIX, легко написать небольшую утилиту на языке сценариев, которая использует `objdump`, `otool` или любую другую существующую утилиту для получения информации из двоичного файла, и импортировать ее результаты в radare. Например, взгляните на `idc2r.py`, которая поставляется с [radare2ida](https://github.com/radareorg/radare2ida). Использование - запуск `idc2r.py file.idc > file.r2`. Она считывает файл IDC, экспортированный из базы данных IDA Pro, и создает скрипт r2, содержащий те же комментарии, имена функций и другие данные. Полученный файл 'file.r2' можно импортировать с помощью команды "точка" `.` radar-а:
```
[0x00000000]> . file.r2
```
Команда `.` используется для интерпретации команд Radare из внешних источников, включая файлы и выходные данные программы. Чтобы пропустить генерацию промежуточного файла и импортировать скрипт напрямую, можно использовать такую комбинацию:
```
[0x00000000]> .!idc2r.py < file.idc
```

Импорт метаданных IDA Pro из дампа IDC является устаревшим механизмом и может не работать в будущем. Рекомендуемый способ - использовать срипт `ida2r2.py`, основанный на [python-idb](https://github.com/williballenthin/python-idb), он открывает IDB файлы напрямую без установки IDA Pro.

Команда `C` используется для управления комментариями и отображением данных. Можно снаблить некоторый диапазон байтов метаданными, указывающими как его следует интерпретировать: код, блок двоичных данных или строкой. Также можно запустить внешнюю программу, передав ей часть данных флага. Программа должна провести анализ и передать обратно метаданные, например, комментарии. Она может получать данные для анализа из внешнего файла или базы данных в том числе.

Существует множество различных команд задания метаданнымх, вот краткий обзор всех из них:

```
[0x00404cc0]> C?
| Usage: C[-LCvsdfm*?][*?] [...]   # Metadata management
| C                                              list meta info in human friendly form
| C*                                             list meta info in r2 commands
| C*.                                            перечень метаданных, привязанных к текущему смещению, команды r2
| C- [len] [[@]addr]                             delete metadata at given address range
| C.                                             list meta info of current offset in human friendly form
| CC! [@addr]                                    edit comment with $EDITOR
| CC[?] [-] [comment-text] [@addr]               add/remove comment
| CC.[addr]                                      show comment in current address
| CCa[-at]|[at] [text] [@addr]                   add/remove comment at given address
| CCu [comment-text] [@addr]                     add unique comment
| CF[sz] [fcn-sign..] [@addr]                    function signature
| CL[-][*] [file:line] [addr]                    show or add 'code line' information (bininfo)
| CS[-][space]                                   manage meta-spaces to filter comments, etc..
| C[Cthsdmf]                                     list comments/types/hidden/strings/data/magic/formatted in human friendly form
| C[Cthsdmf]*                                    list comments/types/hidden/strings/data/magic/formatted in r2 commands
| Cd[-] [size] [repeat] [@addr]                  hexdump data array (Cd 4 10 == dword [10])
| Cd. [@addr]                                    show size of data at current address
| Cf[?][-] [sz] [0|cnt][fmt] [a0 a1...] [@addr]  format memory (see pf?)
| Ch[-] [size] [@addr]                           hide data
| Cm[-] [sz] [fmt..] [@addr]                     magic parse (see pm?)
| Cs[?] [-] [size] [@addr]                       add string
| Ct[?] [-] [comment-text] [@addr]               add/remove type analysis comment
| Ct.[@addr]                                     show comment at current or specified address
| Cv[bsr][?]                                     add comments to args
| Cz[@addr]                                      add string (see Cs?)
```

Добавление комментария к определенной строке/адресу - команда `Ca` :

```
[0x00000000]> CCa 0x0000002 this guy seems legit
[0x00000000]> pd 2
0x00000000    0000         add [rax], al
;      this guy seems legit
0x00000002    0000         add [rax], al
```

Семейство команд `C?` позволяет пометить некоторый диапазон адресов заданным типом. Три основных типа метаданных - это код (дизассемблирование выполняется с помощью asm.arch), блок данных (массив элементов данных) или строка. Команда `cs` - определение метаданных для строки, команда `Cd` - для массива элементов данных, командп `Cf` - определение сложных структур данных.

Аннотация типов данных легче всего выполнять в визуальном режиме, используя клавишу «d», сокращение от "data type change". Используйте курсор для выбора диапазона байтов (нажмите клавишу `c` , чтобы переключить режим курсора, используйте клавиши HJKL для определения области выделения), затем нажмите «d», чтобы получить меню возможных действий / типов. Например, чтобы пометить диапазон как строку, используйте опцию 's' из меню. В командной строке такой же результат получается при помощи команды `Cs`:

```
[0x00000000]> f string_foo @ 0x800
[0x00000000]> Cs 10 @ string_foo
```

Команда `Cf` используется для определения структуры для участка памяти (используется тот же синтаксис, что в команде `pf`). Вот пример:

```
[0x7fd9f13ae630]> Cf 16 2xi foo bar
[0x7fd9f13ae630]> pd
;-- rip:
0x7fd9f13ae630 format 2xi foo bar {
0x7fd9f13ae630 [0] {
 foo : 0x7fd9f13ae630 = 0xe8e78948
 bar : 0x7fd9f13ae634 = 14696
}
0x7fd9f13ae638 [1] {
 foo : 0x7fd9f13ae638 = 0x8bc48949
 bar : 0x7fd9f13ae63c = 571928325
}
} 16
0x7fd9f13ae633    e868390000   call 0x7fd9f13b1fa0
0x7fd9f13ae638    4989c4       mov r12, rax
```

Аргумент `[sz]` у `Cf` используется для задания количества байтов, занимаемых структурой при дизассемблировании, она полностью независима от размера структуры данных, определяемой строкой задания формата. Может это кажется странным, но этому есть несколько применений. Например, можно задать и форматирование структуры, отображаемой при дизассемблировании, и по-прежнему отображать эти адреса в виде смещений и байтаов. Для больших структур удобно идентифицировать только несколько полей, если нужны только они. Затем можно указать r2 отображать только эти поля, используя строку формата и специальные 'skip'-поля, а также продолжить дизассемблирование после отображения всей структуры, задав ей полный размер с помощью аргумента `sz`.

Использование `Cf` позволяет описывать сложные структуры при помощи простых однострочных командных выражений. Посмотрите инструкцию `pf?`.
Помните, что все команды группы `C` также доступны в визуальном режиме, нажав кнопку `d` (data conversion).
В отличие от команды [`t`](../analysis/types.md) команда `Cf` не изменяет результаты анализа. Это только инструмент визуализации.

Иногда добавление одной строки комментария бывает недостаточно, radare2 позволяет создавать ссылки на текстовые файлы. Функция реализуется командой `СС,` или нажатием клавиши `,` в
 визуальном режиме. В результате откроется `$EDITOR` для создания нового файла, если файл существует, просто создаст ссылку. Файл будет показан в комментариях к коду:

```
[0x00003af7 11% 290 /bin/ls]> pd $r @ main+55 # 0x3af7
│0x00003af7  call sym.imp.setlocale        ;[1] ; ,(locale-help.txt) ; char *setlocale(int category, const char *locale)
│0x00003afc  lea rsi, str.usr_share_locale ; 0x179cc ; "/usr/share/locale"
│0x00003b03  lea rdi, [0x000179b2]         ; "coreutils"
│0x00003b0a  call sym.imp.bindtextdomain   ;[2] ; char *bindtextdomain(char *domainname, char *dirname)
```

Найдите `,(locale-help.txt)` в комментариях выше, если теперь снова нажать `,` в визуальном режиме, файл откроется. Используя этот механизм, создаются длинные описания конкретных мест в дизассемблированном коде, устанавливаются ссылки на документацию, статьи по теме.

