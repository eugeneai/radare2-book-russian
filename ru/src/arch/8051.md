Использование r2 с 8051
==================

Инструменты
--------
- [x] Дизассемблер
- [x] Ассемблер
- [x] Эмуляция (esil)
- [x] Отображение адресного пространства

Нетестированные
--------
- [ ] Отладка

Отсутствующие
-------
- [ ] Полная эмуляция отображаемых в памяти регистров
- [ ] Банки памяти для адресных пространств > 64 КБ
- [ ] Расширенный анализ, включающий локальные переменные, параметры функций...
- [ ] Модели ЦП

Конфигурация r2
----------------

Установите архитектуру на 8051:

`r2 -a 8051`

Установите модель процессора:

`e asm.cpu = ?`

После изменения модели процессора запустите 'aei' для инициализации/сброса регистров и отображаемой памяти. Например:

````
e asm.cpu = 8051-generic
aei
````


Адресные пространства и отображение памяти
---------------------------------

Псевдорегистры используются для управления механизмом эмуляции нескольких адресных пространств 8051. Регистры содержат базовый адрес, по которому область памяти 8051 расположена в адресном пространстве r2.

|register|address space|comment|
|--|--|--|
|_code|CODE|Program memory. Typically located at 0.|
|_idata|IDATA|256 bytes of internal RAM.|
|_sfr|SFR|128 bytes for special function registers. _sfr — базовый адрес. Registers start at _sfr+0x80.|
|_xdata|XDATA|64K of external RAM.|
|_pdata|PDATA, XREG|MSB of address of 256-byte page in XDATA accessed with 'movx @Ri' op codes.|

Регистры инициализируются на основе выбранного ЦП. Смотрите инструкцию для 'e asm.cpu=?'.

Регистры можно просматривать и изменять с помощью команды 'ar'. При изменении псевдорегистров или обновления 'asm.cpu' память будет (пере)распределена автоматически при следующем вызове анализатора (например, во время 'aei'). Используйте команду 'om' для просмотра списка выделенных блоков памяти.

````
[0x00000000]> e asm.cpu=8051.generic
[0x00000000]> aei
[0x00000000]> om
 4 fd: 6 +0x00000000 0x00000000 - 0x0000ffff -rwx
 3 fd: 5 +0x00000000 0x20000000 - 0x2000ffff -rw- xdata
 2 fd: 4 +0x00000000 0x10000180 - 0x100001ff -rw- sfr
 1 fd: 3 +0x00000000 0x10000000 - 0x100000ff -rw- idata
````

Анализ и эмуляция основаны на отображении адресов. Настраивайте псевдорегистры перед (пере)запуском анализа.

Адресные пространства могут перекрываться в памяти r2. Это позволяет эмулировать варианты 8051, отражающие IDATA и SFR в XDATA или имеющие общие адресные пространства XDATA и CODE.

Например, CC2430 от Texas Instruments сопоставляет SFR с 0xDF80, а IDATA с 0xFF00 в пространстве памяти XDATA. В r2 это настраивается с помощью:

````
ar _sfr = _xdata + 0xdf00
ar _idata = _xdata + 0xff00
````

Для перекрывающихся областей r2 будет отдавать предпочтение меньшим блокам памяти. Например, если IDATA отображается в XDATA, все операции r2 будут использовать IDATA в перекрывающихся адресах. Если вы хотите вместо этого использовать XDATA, надо удалить нарушающую карту командой 'om-'. Смотрите 'ом?' для получения дополнительной информации.

Для использования эмуляции с перекрывающимся кодом и пространствами ОЗУ память r2, содержащая прошивку, должна разрешать доступ по записи. Лучше всего это достигается с помощью команды 'omf 4 rwx', где 4 — это идентификатор записи карты ввода-вывода файла прошивки. Инструкция — 'ом?'.

Некоторые варианты 8051 используют банкирование памяти для адресации пространств памяти размером более 64 КБ. В настоящее время оно не поддерживается r2.


Советы и рекомендации
-------------

Используйте псевдорегистры в командах r2 для вычисления адресов. Например, вывод шестнадцатеричного дампа всех регистров специальных функций:

`px @ _sfr`

Запись значения по адресу во внешней оперативной памяти

`wx deadbeef @ _xdata + 0x1234`

Установка флага для переменной, хранящейся по адресу 0x20 во внутренней памяти:

`f sym.secret @ _idata + 0x20`


Добавление поддержки новых вариантов 8051
------------------------------------

Следующие действия добавляют поддержку новых вариантов 8051 в r2.

1. Склонировать последнюю версии Radare2,
2. В '/libr/anal/p/anal_8051.c' добавьте новую запись в массив 'cpu_models[]' — определение имени и отображения памяти. Имя последней записи в массиве должно быть NULL.
3. В 'libr/asm/p/asm_8051.c' добавьте запись с тем же именем в атрибут '.cpus'.
4. Скомпилируйте, протестируйте свое дополнение и отправьте запрос на включение (pull request).
