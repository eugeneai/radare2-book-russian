# Справочная карта Radare2

Этот раздел книги основан на справочной карте, разработанной Thanat0s-ом, лицензия - GNU GPL. Первоначальная лицензия была следующая:

```
Эту карточку можно свободно распространять в соответствии с общей публичной лицензией GNU, Copyright Thanat0s - v0.1 -
```

## Руководство по выживанию

Здесь приведены базовые команды, которые необходимо выучить для перемещения по двоичному файлу, получения о нем информации.

| Команда                 | Описание                                |
|:------------------------|:----------------------------------------|
| s (tab)                 | Установить смещение куда-либо           |
| x [nbytes]              | Шестнадцатеричный дамп n байтов, $b по умолчанию  |
| aa                      | Анализировать автоматически             |
| pdf@ [funcname](Tab)    | Дизассемблировать функцию (main, fcn, и т.д.)  |
| f fcn(Tab)              | Перечислить функции                     |
| f str(Tab)              | Перечислить строки                      |
| fr [flagname] [newname] | Переименовать флаг                      |
| psz [offset]~grep       | Вывод строки и grep-пинг нужной         |
| axF [flag]              | Найти перекрестные ссылки на флаг       |

## Флаги

Флаг — это закладка в коде бинарного файла, но с дополнительной информацией, в частности, размер, теги и ассоциированное с ним пространство флагов. Команда `f` используется для перечисления, задания флагов, а также получения информации о них.

| Команда             | Описание              |
|:--------------------|:----------------------|
| f                   | Перечислить флаги     |
| fd $$               | Показать информацию о смещении    |
| fj                  | Показать флаги в формате JSON |
| fl                  | Показать длину флага  |
| fx [flagname]       | Показать шестнадцатеричный дамп флага  |
| fC [name] [comment] | Показать комментарий о флаге  |

## Пространство флагов

Флаги создаются в пространствах имен, по умолчанию пространство не выбрано, и команда перечисления флагов будет показывать их все. Если требуются флаги из конкретного подмножества, используется команда `fs`, позволяющая задавать ограничения.

| Команда       | Описание              |
|:--------------|:----------------------|
| fs            | Показать пространства флагов    |
| fs *          | Выбрать все пространства флагов |
| fs [space]    | Выбрать пространство флагов  |

## Информация

Двоичные файлы включают в себя важную информацию, хранящуюся в заголовках. Команда `i` использует API RBin и позволяет получать информацию в rabin2. Вот наиболее часто используемые команды.

| Команда | Описание                 |
|:--------|:-------------------------|
| ii      | Информация об импортах   |
| iI      | Информация о двоичном коде |
| ie      | Показать точку входа     |
| iS      | Показать секции          |
| ir      | Показать переопределения |
| iz      | Перечислить строки (izz, izzz) |

## Печать строк

Существуют различные способы представления строк в памяти. Команда `ps` позволяет печатать их в кодировке utf-16, в форматах pascal, С (заканчивающихся нулем), и др.

| Команда      | Описание                       |
|:-------------|:-------------------------------|
| psz [offset] | Печать строки С (с нулем на конце)   |
| psb [offset] | Печать строки в текущем блоке |
| psx [offset] | Показать строку с использованием escape-последовательностей  |
| psp [offset] | Печать строки pascal           |
| psw [offset] | Печать wide-строки             |


## Визуальный режим

Визуальный режим поддерживает интерактивный режим взаимодействия с radare2. Вход в этот режим — команда `v` или `V`, после чего большинство операций выполняется клавишами клавиатуры.

| Команда        | Описание                                          |
|:---------------|:--------------------------------------------------|
| V              | Вход в визуальный режим                           |
| p/P            | Смена режимов отображения (hex, disasm, debug, words, buf)     |
| c              | Включить/выключить курсор (c)                     |
| q              | Вернуться в командную строку radare2              |
| hjkl           | Перемещение области на экране (или HJKL)  (влево-вниз-вверх-вправо)        |
| Enter          | Перейти по адресу jump-а или call                 |
| sS             | Step/step over (отладка)                          |
| o              | Переключиться между asm.pseudo и asm.esil                    |
| .              | Установить смещение на адрес в программном счетчике  |
| /              | В режиме курсора провести поиск в текущем блоке   |
| :cmd           | Запустить команду radare                          |
| ;[-]cmt        | Добавить или удалить комментарий                  |
| /*+-[]         | Изменить размер блока, [] = resize hex.cols       |
| <,>            | Поиск с учетом выравнивания размер блока          |
| i/a/A          | вставить (i) hex, (a)ссемблировать код, визуальный (A)ссемблер |
| b              | Включить/выключить точку останова                 |
| B              | Просмотр evals, symbols, flags, classes, ...      |
| d[f?]          | Задать функцию, описать данные, код, ...          |
| D              | Вход в режим визуального сравнения (установить diff.from/to)  |
| e              | Редактировать конфигурационные переменные         |
| f/F            | Задать/удалить флаг                               |
| gG             | Установить смещение на начало или конец файла (0-$s)  |
| mK/’K          | Пометить/перейти на Ключ (любой ключ)             |
| M              | Обойти подмонтированные файловые системы          |
| n/N            | Установить смещение на следующую/предыдущую функцию/флаг/вхождение поиска (scr.nkey)       |
| C              | Переключить отображение в цвете или ч/б           |
| R              | Сгенерировать случайную палитру цветов (ecr)      |
| tT             | Управление панелями на экране. Читайте раздел [Панели](visual_panels.md)    |
| v              | Меню анализа кода в визуальном режиме             |
| V              | Просмотр графа (agv?)                             |
| wW             | Переместить курсов на следующее/предыдущее слово  |
| uU             | Отменить/повторить установку смещения             |
| x              | Показать перекрестные ссылки (xrefs) для текущей функции из/в данные/код |
| yY             | Копирование и вставка выделения     |
| z              | скрыть/раскрыть комментарии в дизассемблировании |


## Поиск

Возникает много разных задач, где требуется найти значение внутри двоичного файла или в конкретных областях. Синтаксическая структура `e search.in=?` позволяет указывать, где команда `/` будет осуществлять поиск заданного значения.

| Команда        | Описание                                   |
|:---------------|:----------------------------------------------|
| / foo\00       | Поиск строки ’foo\0’                     |
| /b             | Поиск в обратном направлении |
| //             | повторить предыдущий поиск |
| /w foo         | Поиск wide-строки ’f\0o\0o\0’            |
| /wi foo        | Поиск wide-строки, игнорируя размер букв          |
| /! ff          | Поиск первых несоответствующих вхождений      |
| /i foo         | Поиск строки ’foo’, игнорируя размер букв      |
| /e /E.F/i      | Сопоставить с регулярным выражением |
| /x a1b2c3      | Поиск байтов; пробелы и [0-9a-fA-F] допустимы, аналогично /x A1 B2 C3 |
| /x a1..c3      | Поиск байтов, игнорируя некоторые hex-числа (автоматически сгенерированная маска, в этом примере: ff00ff)|
| /x a1b2:fff3   | Поиск байтов по маске (указываются индивидуальные биты) |
| /d 101112      | Поиск дельтифицированной последовательности байтов |
| /!x 00         | Инверсный поиск hex (найти первый байт != 0x00) |
| /c jmp [esp]   | Поиск ассемблерного кода (смотрите search.asmstr) |
| /a jmp eax     | Ассемблировать оп-код и искать его байты |
| /A             | Поиск открытых AES-ключей |
| /r sym.printf  | Анализировать, куда ссылается оп-код          |
| /R             | Поиск гаджетов ROP |
| /P             | Показать смещение предыдущей инструкции |
| /m magicfile   | Поиск следующего magic-файла                |
| /p patternsize | Поиск шаблона заданного размера |
| /z min max     | Поиск строки заданного размера |
| /v[?248] num   | Поиск 32-битового значения, учитывая asm.bigendian |

## Сохранения (сломано)

Эти функции не работают так, как указано в спецификации на момент написания книги (16 ноября 2020). Дополнительная информация - [#Ошибка 6945: META - Project files](https://github.com/radareorg/radare2/issues/6945) и [#Ошибка 17034](https://github.com/radareorg/radare2/issues/17034).

Чтобы записать результаты анализа (пока проблемы не решены) напишите себе скрипт, который будет сохранять имя функции, имена переменных, и т.д., например:
```sh
vim sample_A.r2

e scr.utf8 = false
s 0x000403ce0
aaa
s fcn.00403130
afn return_delta_to_heapaddr
afvn iter var_04h
...

```

## Использование переменных в выражениях

Команда `?$?` показывает переменные, которые можно использовать в математических операциях в командной строки r2. Например, команда `? $$` вычисляет число, а `?v` - печатает значение в одном из форматов. Все команды r2 принимают эти переменные в качестве параметров.

| Команда                 | Описание|
|:--------------|:-------------------------------------------------|
| $$            | here (текущее смещение в виртуальном адресном пространстве)|
| $$$           | текущее невременное виртуальное смещение |
| $?            | последний результат сравнения |
| $alias=value  | задать синоним (простейшие макросы)|
| $b            | размер блока|
| $B            | базовый адрес (выровненный наименьший адрес отображения)|
| $f            | адрес перехода jump, если условие ложно (jz 0x10 => следующая инструкция)|
| $fl           | длина флага (размер), ассоциированного с данным адресом (fla; pD $l @ entry0)|
| $F            | размер текущей функции|
| $FB           | начало функции|
| $Fb           | адрес текущего базового блока|
| $Fs           | размер текущего базового блока|
| $FE           | конец функция|
| $FS           | размер функции|
| $Fj           | целевой адрес перехода из функции|
| $Ff           | целевой false-адрес функции|
| $FI           | инструкции функции|
| $c,$r         | получить ширину и высоту терминала|
| $Cn           | получить n-тый вызов функции|
| $Dn           | получить n-ю ссылку на данные в функции|
| $D            | текущий адрес базы отображения в режиме отладки ?v $D @ rsp|
| $DD           | текущий размер отображения в режиме отладки|
| $e            | 1 если в конце блока, иначе 0|
| $j            | адрес jump-а (например, jmp 0x10, jz 0x10 => 0x10)|
| $Ja           | получить n-тый jump функции|
| $Xn           | получить n-ый xref функции|
| $l            | длина оп-кода|
| $m            | ссылка оп-кода на память (например, mov eax,[0x10] => 0x10)|
| $M            | адрес отображения (наименьший адрес отображения)|
| $o            | here (текущее смещение на диске, io)|
| $p            | getpid()|
| $P            | pid дочернего процесса (только в отладчике)|
| $s            | размер файла|
| $S            | смещение секции|
| $SS           | размер секции|
| $v            | immediate-значение оп-кода (например, lui a0,0x8010 => 0x8010)|
| $w            | получить размер слова, 4 если asm.bits=32, 8 если 64, ...|
| ${ev}         | значение конфигурационной переменной|
| $r{reg}       | значение поименованного регистра|
| $k{kv}        | получить ответ на запрос к sdb|
| $s{flag}      | размер флага|
| RNum          | переменные формата $variables, полезные в математических выражениях|
