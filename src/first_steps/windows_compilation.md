## Windows

Компилирование `г2` в Windows требует использования системы сборки Meson. Вообще существует возможность сборки r2 в Windows с использованием cygwin, mingw или wsl, используя в качестве системы сборки acr/make, однако этот подход не является рекомендуемым/официальным/поддерживаемым и может привести к неожиданным результатам.

Готовые двоичные сборки загружаются со страницы релизов, кроме того, можно использовать артефакты GITHUB CI, создаваемые на каждый коммит как для 32-разрядной, так и 64-разрядной версий Windows.

* https://github.com/radareorg/radare2/releases

### Необходимые условия

* Требуется 3 ГБ свободного места на диске
* Visual Studio 2019 (or higher)
* Python 3
* Meson
* Ninja
* Git

### Последовательность шагов

#### Установка Visual Studio 2015 или более поздней версии

Visual Studio должна включать компилятор Visual C++, поддерживающий библиотеки C++, и соответствующий пакет Windows SDK для целевой версии платформы.

* Убедитесь, что задан `Programming Languages > Visual C++`

Если у вас не установлена Visual Studio, то грузите какую-нибудь версию community-edition, эти версии бесплатны и отлично работают.

* [Загрузка Visual Studio 2019](https://visualstudio.microsoft.com/downloads/)

#### Установка Python 3 и Meson при помощи пакетного менеджера Conda

Conda - это, вероятно, лучший дистрибутив Python для Windows. Пропустите следующие шаги, если у вас уже установлен Python

* https://docs.conda.io/en/latest/miniconda.html
* https://repo.anaconda.com/archive/

##### Создание среды (environment) Python для Radare2

Следующие действия создают и активируют среду Conda с именем *r2*. Все дальнейшие инструкции приводятся в предположении, что имя среды `r2`, при желании имя можно изменить.

1. Пуск > Anaconda Prompt
2. `conda create -n r2 python=3`
3. `activate r2`

Всякий раз, когда вы входите в среду, открыв Anaconda Prompt, надо запускать `activate r2`. И наоборот, запуск `deactivate` отключает от среды.

##### Установка Meson

Убедитесь, что установлен Meson версии 0.48 или выше (`meson -v`)

```
pip install meson
```

#### Установка Git for Windows

Разработка Radare2 ведется в системе управления версиями Git, исходный код [опубликован на GitHub](https://github.com/radareorg).

Установка Git для Windows требует выполнения следующих действий.

Загрузка  Windows-версии Git

* https://git-scm.com/download/win

Во время установки проверьте следующие параметры.

* Использовать шрифт TrueType во всех окнах консоли
* Использовать Git из командной строки Windows
* Использовать библиотеку Windows Secure Channel, вместо OpenSSL
* Установить флаг Windows-style, коммит - Unix-style для кодирования концов строк(core.autocrlf=true)
* Использовать окно консоли Windows по умолчанию, вместо Mintty
* Убедитесь, что `git --version` срабатывает после инсталляции


#### Загрузка исходного кода Radare2

Следующие действия приводят к клонированию git-репозитория Radare2.

```
git clone https://github.com/radareorg/radare2
```

#### Компилирование Radare2 Code

Следующие действия - компиляция кода Radare2.

* **Visual Studio 2017:**

  Замечание 1: Замените `Community` на `Professional` или `Enterprise` в следующем примере командной строки в зависимости от используемой вами версии.

  Замечание 2: Замените `vcvars32.bat` на `vcvars64.bat` в этой строке для сборки 64-битовой версии.

  `"%ProgramFiles(x86)%\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars32.bat"`

4. Создание системы сборки с помощью Meson:

В командной строке Meson можно задавать аргументы для настройки типа сборки. Однако, r2 должен собраться без дополнительных флагов meson-а. При использовании Visual Studio. Замечание: Замените `Debug` на `Release` в следующей строке в зависимости от намерения собрать версию для отладки или релиз.

```
meson b --buildtype debug --backend vs2019 --prefix %cd%\dest
msbuild build\radare2.sln /p:Configuration=Debug /m
```

При использовании Ninja интерфейс Visual Studio не требуется, достаточно установить инструменты компилятора msvc:

```
meson b
ninja -C b
```

Наконец, надо запустить следующую строку для установки r2 в заданный каталог (абсолютный префикс):

```
meson install -C build --no-rebuild
```

#### Заметки о параметрах сборки

Параметр `/m[axcpucount]` создает один рабочий процесс MSBuild для каждого процессорного ядра компьютера. Указание числового значения (например, `/m:2`) ограничивает количество рабочих процессов. (Не следует путать с параметром компилятора Visual C++ `/MP`.)

Иногда при попытке 32-разрядной установки можно получить сообщение такого вида: `error MSB4126: The specified solution configuration "Debug|x86" is invalid.` Проблема решается добавлением следующего аргумента: `/p:Platform=Win32`.

Проверить версию собранного Radare2: `dest\bin\radare2.exe -v`

#### Как убедится, что Radare2 запускается из любой папки

В системах UNIX `r2` — это просто символьная ссылка на исполняемый файл `radare2`. В Windows если вы хотите, чтобы у вас был именно `r2`, то надо просто скопировать в него `radare2.exe`: `copy radare2.exe r2.exe`. Также надо добавить каталог с этими файлами в переменную PATH в настройках **Проводника** Windows.

Откройте консоль `cmd.exe` и наберите `r2 -v`. Если не получите ошибку, то весь процесс сборки и установки прошел успешно.

#### Примечания по настройке общесистемных (system-wide) переменных среды

1. В проводнике windows перейдите в папку Radare2, т.е., в которую только что мы устанавливали пакет.
2. Из этой папки перейдите в `dest` > `bin` и оставьте окно открытым. ``
3. Перейдите в раздел "Свойства системы" (System Properties): в строке поиска Windows введите `sysdm.cpl`.
4. Перейдите в `Дополнительно > Переменные среды` (`Advanced > Environment Variables`).
5. Щелкните на переменной PATH, затем нажмите кнопку edit. Если PATH присутствует в настройках и для пользователя, и среди перечня системных переменных, то лучше править пользовательскую.
6. Проверьте наличие в переменной PATH пути к папке в оставленном ранее окне. Если это не так, добавьте эту папку и нажмите `OK`.
7. Выйдите из сеанса Windows.
8. Откройте командную строку Windows: введите `cmd` в строке поиска. Убедитесь, что текущая папка не папка Radare2.
9. Проверьте работоспособность Radare2 в командной строке: `radare2 -v`
